<html>
<head>
    <style>
        html, body, #map-canvas {
            height: 100%;
            margin: 0px;
            padding: 0px
        }
    </style>
    <script src="/js/jquery-2.1.3.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script>
        function loadMap(data) {
            var mapOptions = {
                zoom: 15,
                center: new google.maps.LatLng(44.998501, -93.246544), // spyhouse
                mapTypeId: google.maps.MapTypeId.TERRAIN
            };

            var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

            var coordinates = [];
            var coord_readings = {};
            // assoc readings with to coordinate
            for (var i = 0; i < data.length; i++) {
                var point_entry = coord_readings[data[i].location];
                if (!point_entry) {
                    point_entry = {'lux': [], 'tmp': []};
                    coord_readings[data[i].location] = point_entry;
                }
                for (var j = 0; j < data[i].readings.length; j++) {
                    console.log("data[i]: "+JSON.stringify(data[i]));
                    console.log("nature: "+JSON.stringify(data[i].nature));
                    var t = point_entry[data[i].nature];
                    t.push(data[i].readings[j]);
                }
                coord_readings[data[i].location] = point_entry;
            }
            // create map lines according to coordinate keys
            var keys = Object.keys(coord_readings);
            for(var m=0; m < keys.length; m++) {
                var points = keys[m].split(' ');
                var lat = points[0];
                var lon = points[1];
                var gpoint = new google.maps.LatLng(lat, lon);
                coordinates.push(gpoint);
                var robotPath = new google.maps.Polyline({
                    path: coordinates,
                    geodesic: false,
                    strokeColor: '#FF0000',
                    strokeOpacity: 1.0,
                    strokeWeight: 2
                });
            }
            robotPath.setMap(map);
        }
    </script>
    {% if tracked_robot %}
        <script>
            (function poll() {
                setTimeout(function () {
                    $.ajax({
                        type: 'GET',
                        dataType: 'json',
                        url: '{% uri_for robot-event-get robot_id=tracked_robot.robot_id %}',
                        success: function (data) {
                            loadMap(data);
                        },
                        complete: poll
                    });
                }, 5000);
            })();
        </script>
    {% endif %}
</head>

<body>

<a href="{% uri_for main %}">home</a>

<h1>Robot Tracker</h1>

{% if robots %}
    {% for robot in robots %}
    <a href="{% uri_for robot-track-get robot_id=robot.robot_id %}">track robot {{ robot.robot_id }}</a>
    {% endfor %}
{% else %}
    <h2>No robots found!</h2>
    A robot has to send us sensor data for us to show.
{% endif %}

<div id="map-canvas"></div>

</body>

</html>
